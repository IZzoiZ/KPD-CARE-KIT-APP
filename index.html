<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPD Care App</title>
    <!-- Include Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include React and Babel to run JSX in the browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Include Firebase for authentication and database -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, orderBy, addDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
        // Initialize Firebase services and make them globally accessible
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.appId = appId;

        // Sign in anonymously or with custom token on load
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Authentication error:", error);
            }
        }
        signIn();
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-sans">
    <div id="root" class="w-full"></div>

    <!-- The main React component code, transformed by Babel in the browser -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // The main application component
        const App = () => {
            // State for managing app data and UI
            const [user, setUser] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [currentPhase, setCurrentPhase] = useState('idle');
            const [timerSeconds, setTimerSeconds] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [showReminderSent, setShowReminderSent] = useState(false);

            // Set up authentication state listener
            useEffect(() => {
                const unsubscribe = window.auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        console.log("User signed in with UID:", currentUser.uid);
                    } else {
                        console.log("User signed out.");
                    }
                });
                return () => unsubscribe();
            }, []);

            // Set up Firestore real-time data listener for sessions
            useEffect(() => {
                let unsubscribe;
                if (user) {
                    try {
                        const sessionsCollectionRef = window.db.collection(window.db.getFirestore(), `artifacts/${window.appId}/users/${user.uid}/sessions`);
                        const q = window.db.query(sessionsCollectionRef, window.db.orderBy('timestamp', 'desc'));
                        
                        unsubscribe = window.db.onSnapshot(q, (snapshot) => {
                            const sessionsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setSessions(sessionsData);
                        }, (error) => {
                            console.error("Error fetching sessions:", error);
                        });
                    } catch (error) {
                        console.error("Error setting up snapshot listener:", error);
                    }
                }
                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, [user]);

            // Timer logic using useEffect
            useEffect(() => {
                let timerInterval = null;
                if (isTimerRunning) {
                    timerInterval = setInterval(() => {
                        setTimerSeconds(prevSeconds => prevSeconds + 1);
                    }, 1000);
                } else if (!isTimerRunning && timerSeconds !== 0) {
                    clearInterval(timerInterval);
                }
                return () => clearInterval(timerInterval);
            }, [isTimerRunning]);

            // Helper function to format time in MM:SS
            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            };

            // Function to save a new session entry to Firestore
            const saveSession = async (phase, duration) => {
                if (!user) {
                    console.error("User is not authenticated. Cannot save session.");
                    return;
                }
                try {
                    const sessionsCollectionRef = window.db.collection(window.db.getFirestore(), `artifacts/${window.appId}/users/${user.uid}/sessions`);
                    await window.db.addDoc(sessionsCollectionRef, {
                        phase,
                        duration,
                        timestamp: window.db.serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };
            
            // Function to simulate sending an SMS reminder
            const sendSmsReminder = () => {
                setShowReminderSent(true);
                setTimeout(() => {
                    setShowReminderSent(false);
                }, 3000);
            };

            // Main button click handler for phase transitions
            const handleButtonClick = () => {
                if (currentPhase === 'idle') {
                    setCurrentPhase('warming');
                    setTimerSeconds(0);
                    setIsTimerRunning(true);
                } else if (currentPhase === 'warming') {
                    saveSession('warming', timerSeconds);
                    setCurrentPhase('filling');
                    setTimerSeconds(0);
                } else if (currentPhase === 'filling') {
                    saveSession('filling', timerSeconds);
                    setCurrentPhase('dwell');
                    setTimerSeconds(0);
                } else if (currentPhase === 'dwell') {
                    saveSession('dwell', timerSeconds);
                    setCurrentPhase('draining');
                    setTimerSeconds(0);
                } else if (currentPhase === 'draining') {
                    saveSession('draining', timerSeconds);
                    setCurrentPhase('complete');
                    setIsTimerRunning(false);
                    setTimeout(() => {
                        setCurrentPhase('idle');
                    }, 3000);
                }
            };

            // Determine button state and text based on current phase
            let buttonText = 'Start Treatment';
            let buttonColor = 'bg-blue-600 hover:bg-blue-700';
            let isButtonDisabled = false;
            
            if (currentPhase !== 'idle' && currentPhase !== 'complete') {
                buttonText = 'Next Phase';
                buttonColor = 'bg-green-500 hover:bg-green-600';
            } else if (currentPhase === 'complete') {
                buttonText = 'Cycle Complete!';
                buttonColor = 'bg-green-500 cursor-default';
                isButtonDisabled = true;
            }

            return (
                <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm sm:max-w-md mx-auto transform transition-all duration-500 ease-in-out hover:scale-105">
                    {/* Reminder Sent Toast UI */}
                    {showReminderSent && (
                        <div className="fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50">
                            Reminder sent!
                        </div>
                    )}
                    
                    {/* Header Section */}
                    <div className="flex flex-col items-center mb-6">
                        <svg className="h-12 w-12 text-blue-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                        <h1 className="text-3xl font-bold text-gray-900 mb-1">KPD CARE App</h1>
                        <p className="text-sm text-gray-500">Kashmir Peritoneal Dialysis Companion</p>
                    </div>

                    {/* Status and Timer Display */}
                    <div className="bg-blue-50 text-blue-800 rounded-2xl p-5 mb-6 text-center shadow-inner">
                        <h2 className="text-xl font-semibold mb-1">Current Phase:</h2>
                        <p className="text-4xl font-extrabold capitalize mb-2">{currentPhase}</p>
                        <div className="border-t border-blue-200 pt-3">
                            <p className="text-sm font-medium">Time Elapsed</p>
                            <p className="text-2xl font-bold">{formatTime(timerSeconds)}</p>
                        </div>
                    </div>

                    {/* Control Buttons */}
                    <div className="flex flex-col gap-4">
                        <button
                            onClick={handleButtonClick}
                            disabled={isButtonDisabled}
                            className={`w-full ${buttonColor} text-white font-bold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:-translate-y-1 shadow-lg`}
                        >
                            {buttonText}
                        </button>
                        
                        <button
                            onClick={sendSmsReminder}
                            className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:-translate-y-1 shadow-lg"
                        >
                            Send SMS Reminder
                        </button>
                    </div>

                    {/* Session Log */}
                    <div className="bg-gray-100 rounded-2xl p-4 shadow-inner overflow-y-auto max-h-72 mt-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-3">Session Log</h3>
                        {sessions.length > 0 ? (
                            <ul className="space-y-2">
                                {sessions.map((session, index) => (
                                    <li key={session.id || index} className="bg-white rounded-lg p-3 shadow-md border-l-4 border-blue-500 flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold text-gray-700 capitalize">{session.phase} Phase</p>
                                            <p className="text-xs text-gray-500">
                                                {session.timestamp ? new Date(session.timestamp.seconds * 1000).toLocaleString() : 'Loading...'}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm font-medium text-gray-600">Duration</p>
                                            <p className="font-bold text-gray-800">{formatTime(session.duration)}</p>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-center text-gray-400 text-sm italic">
                                {user ? "No sessions logged yet." : "Please wait, loading..."}
                            </p>
                        )}
                    </div>
                    {/* User ID Display */}
                    {user && (
                        <div className="mt-4 text-center text-sm text-gray-500 break-words">
                            Your User ID: <span className="font-mono">{user.uid}</span>
                        </div>
                    )}
                </div>
            );
        };

        // Render the main App component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
